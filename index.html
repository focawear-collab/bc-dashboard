<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLACK CHICKEN ‚Äî Dashboard Hist√≥rico</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --gold: #C9A84C;
    --gold-light: #E8C97A;
    --black: #0A0A0A;
    --dark: #111111;
    --card: #181818;
    --card2: #1E1E1E;
    --border: #2A2A2A;
    --text: #E8E8E8;
    --muted: #888;
    --green: #4CAF50;
    --red: #E53935;
    --yellow: #FFC107;
    --blue: #42A5F5;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--black);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: var(--dark);
    border-bottom: 1px solid var(--border);
    padding: 18px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .logo-icon {
    width: 36px; height: 36px;
    background: var(--gold);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue';
    font-size: 18px;
    color: var(--black);
  }
  .logo-text { font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 3px; color: var(--gold); }
  .logo-sub { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }
  .header-right { display: flex; align-items: center; gap: 8px; }
  .badge {
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 11px;
    color: var(--muted);
    font-family: 'DM Mono';
  }
  .badge.live { border-color: var(--gold); color: var(--gold); }

  /* TABS */
  .tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    background: var(--dark);
  }
  .tab {
    padding: 12px 20px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .tab.active { color: var(--gold); border-bottom-color: var(--gold); }
  .tab:hover:not(.active) { color: var(--text); }

  /* LAYOUT */
  .main { padding: 28px 32px; max-width: 1600px; margin: 0 auto; }
  .section { display: none; }
  .section.active { display: block; }

  /* KPI STRIP */
  .kpi-strip {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 24px;
  }
  .kpi {
    background: var(--card);
    padding: 18px 20px;
    position: relative;
  }
  .kpi-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 6px; }
  .kpi-value { font-family: 'Bebas Neue'; font-size: 26px; color: var(--text); letter-spacing: 1px; line-height: 1; }
  .kpi-value.gold { color: var(--gold); }
  .kpi-value.green { color: var(--green); }
  .kpi-value.red { color: var(--red); }
  .kpi-sub { font-size: 11px; color: var(--muted); margin-top: 4px; font-family: 'DM Mono'; }
  .kpi-delta {
    position: absolute;
    top: 14px; right: 14px;
    font-size: 10px;
    font-family: 'DM Mono';
    padding: 2px 6px;
    border-radius: 3px;
  }
  .kpi-delta.up { background: rgba(76,175,80,0.15); color: var(--green); }
  .kpi-delta.down { background: rgba(229,57,53,0.15); color: var(--red); }

  /* CHARTS GRID */
  .charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }
  .charts-grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }
  .chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
  }
  .chart-title {
    font-family: 'Bebas Neue';
    font-size: 15px;
    letter-spacing: 2px;
    color: var(--gold);
    margin-bottom: 4px;
  }
  .chart-sub { font-size: 11px; color: var(--muted); margin-bottom: 18px; }
  .chart-container { position: relative; }

  /* TABLE */
  .table-wrap {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 16px;
  }
  .table-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  table { width: 100%; border-collapse: collapse; }
  thead th {
    background: var(--card2);
    padding: 10px 14px;
    text-align: right;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
  }
  thead th:first-child { text-align: left; }
  tbody tr { border-bottom: 1px solid #1C1C1C; transition: background 0.15s; }
  tbody tr:hover { background: rgba(201,168,76,0.04); }
  tbody tr:last-child { border-bottom: none; }
  tbody td {
    padding: 10px 14px;
    text-align: right;
    font-family: 'DM Mono';
    font-size: 12px;
    color: var(--text);
  }
  tbody td:first-child { text-align: left; font-family: 'DM Sans'; font-weight: 500; color: var(--gold-light); }
  .td-good { color: var(--green) !important; }
  .td-warn { color: var(--yellow) !important; }
  .td-bad { color: var(--red) !important; }
  .td-muted { color: var(--muted) !important; font-size: 11px !important; }

  /* ALERT BANNER */
  .alert-row {
    display: grid;
    grid-template-columns: repeat(3,1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  .alert-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 18px;
    border-left: 3px solid var(--border);
  }
  .alert-card.red { border-left-color: var(--red); }
  .alert-card.yellow { border-left-color: var(--yellow); }
  .alert-card.green { border-left-color: var(--green); }
  .alert-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .alert-card.red .alert-title { color: var(--red); }
  .alert-card.yellow .alert-title { color: var(--yellow); }
  .alert-card.green .alert-title { color: var(--green); }
  .alert-body { font-size: 13px; color: var(--text); line-height: 1.5; }
  .alert-body strong { color: var(--gold-light); }

  /* DIVIDER */
  .section-divider {
    font-family: 'Bebas Neue';
    font-size: 12px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
    margin: 20px 0 12px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .section-divider::after { content:''; flex:1; height:1px; background: var(--border); }

  /* TOGGLE LOCAL */
  .local-toggle {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
  }
  .local-btn {
    padding: 7px 18px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    font-size: 12px;
    font-family: 'DM Sans';
    font-weight: 500;
    letter-spacing: 1px;
    transition: all 0.2s;
  }
  .local-btn.active { background: var(--gold); border-color: var(--gold); color: var(--black); }

  /* INSIGHT BOX */
  .insight {
    background: rgba(201,168,76,0.06);
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 16px;
  }
  .insight-title { font-size: 11px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; font-weight: 600; }
  .insight-text { font-size: 13px; color: var(--text); line-height: 1.7; }
  .insight-text strong { color: var(--gold-light); }

  @media(max-width:900px) {
    .kpi-strip { grid-template-columns: repeat(3,1fr); }
    .charts-grid, .charts-grid-3 { grid-template-columns: 1fr; }
    .alert-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">BC</div>
    <div>
      <div class="logo-text">Black Chicken</div>
      <div class="logo-sub">Dashboard Hist√≥rico ¬∑ 2025‚Äì2026</div>
    </div>
  </div>
  <div class="header-right">
    <span class="badge">BC1 Las Condes</span>
    <span class="badge">BC2</span>
    <span class="badge live">‚óè Ene 2026</span>
  </div>
</header>

<div class="tabs">
  <div class="tab active" onclick="showSection('overview')">Visi√≥n General</div>
  <div class="tab" onclick="showSection('ventas')">Ventas</div>
  <div class="tab" onclick="showSection('costos')">Costos & Margen</div>
  <div class="tab" onclick="showSection('personal')">Personal</div>
  <div class="tab" onclick="showSection('tabla')">Tabla Completa</div>
</div>

<div class="main">

<!-- ===================== OVERVIEW ===================== -->
<div class="section active" id="section-overview">

  <div class="kpi-strip">
    <div class="kpi">
      <div class="kpi-label">Venta Total 2025</div>
      <div class="kpi-value gold">$1.838M</div>
      <div class="kpi-sub">BC1+BC2 acumulado</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Mejor mes BC1</div>
      <div class="kpi-value">$152.7M</div>
      <div class="kpi-sub">Octubre 2025</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Mejor mes BC2</div>
      <div class="kpi-value">$53.7M</div>
      <div class="kpi-sub">Julio 2025</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">COGS prom BC1</div>
      <div class="kpi-value red">30.9%</div>
      <div class="kpi-sub">Target: &lt;30%</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">COGS prom BC2</div>
      <div class="kpi-value green">29.7%</div>
      <div class="kpi-sub">Target: &lt;30%</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Ene 2026 vs Ene 2025</div>
      <div class="kpi-value green">+1.5%</div>
      <div class="kpi-sub">BC1: $135.8M vs $133.8M</div>
    </div>
  </div>

  <div class="alert-row">
    <div class="alert-card red">
      <div class="alert-title">üî¥ Alerta Cr√≠tica</div>
      <div class="alert-body">
        <strong>Dic 2025:</strong> BC1 ganancia m√≠nima (<strong>$331K</strong>) ‚Äî casi breakeven. Personal BC2 lleg√≥ a <strong>44%</strong> sobre ventas. Doble problema simult√°neo.
      </div>
    </div>
    <div class="alert-card yellow">
      <div class="alert-title">‚ö†Ô∏è Tendencia Personal</div>
      <div class="alert-body">
        Costo personal BC1 escal√≥ de <strong>22.4%</strong> (Mar) a <strong>29.6%</strong> (Ene 2026). BC2 nunca baj√≥ de <strong>21.9%</strong> y picos de <strong>44%</strong>. Target: &lt;20%.
      </div>
    </div>
    <div class="alert-card green">
      <div class="alert-title">‚úÖ Oportunidad</div>
      <div class="alert-body">
        Jul & Oct son los <strong>mejores meses hist√≥ricos</strong>. BC2 mostr√≥ COGS excelente en <strong>26.8%</strong> (Jul) y <strong>27.7%</strong> (Dic). Hay capacidad operativa disponible.
      </div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Ventas Mensuales BC1 + BC2</div>
      <div class="chart-sub">Ene 2025 ‚Äî Ene 2026 ¬∑ Pesos chilenos</div>
      <div class="chart-container" style="height:280px">
        <canvas id="chartVentasCombinadas"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Ganancia Neta</div>
      <div class="chart-sub">BC1 vs BC2 ¬∑ Pesos chilenos</div>
      <div class="chart-container" style="height:280px">
        <canvas id="chartGanancia"></canvas>
      </div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">COGS % ‚Äî Food Cost</div>
      <div class="chart-sub">BC1 vs BC2 ‚Äî L√≠nea roja = target 30%</div>
      <div class="chart-container" style="height:220px">
        <canvas id="chartCOGS"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Costo Personal %</div>
      <div class="chart-sub">BC1 vs BC2 ‚Äî L√≠nea roja = target 20%</div>
      <div class="chart-container" style="height:220px">
        <canvas id="chartPersonal"></canvas>
      </div>
    </div>
  </div>

  <div class="insight">
    <div class="insight-title">üìä An√°lisis Ejecutivo ‚Äî 13 Meses</div>
    <div class="insight-text">
      <strong>BC1</strong> es el motor principal con ventas promedio de <strong>$138.7M/mes</strong> en 2025. El COGS se mantuvo por sobre el target en la mayor√≠a de meses (prom 30.9%). El costo de personal es el mayor riesgo: escal√≥ de 22% en el primer semestre a casi 30% en el segundo semestre. <br><br>
      <strong>BC2</strong> alcanz√≥ su velocidad de crucero en el Q2 2025 ($42-47M/mes). COGS mejor controlado (prom 29.7%) pero el personal es ca√≥tico: rango de 21.9% a 44%, con picos cr√≠ticos en Dic 2025 (44%) y Jun 2025 (34.7%). <br><br>
      <strong>Enero 2026</strong>: BC1 crece solo +1.5% vs Ene 2025. BC2 sube a $47M (+30% vs Feb 2025 primer mes completo). COGS BC1 en 31.06% ‚Äî por encima del target. Personal combinado problem√°tico: BC1 29.6%, BC2 32.3%.
    </div>
  </div>
</div>

<!-- ===================== VENTAS ===================== -->
<div class="section" id="section-ventas">
  <div class="section-divider">An√°lisis de Ventas por Local</div>

  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Evoluci√≥n Ventas BC1</div>
      <div class="chart-sub">Ventas brutas mensuales</div>
      <div class="chart-container" style="height:260px">
        <canvas id="chartBC1ventas"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Estacionalidad</div>
      <div class="chart-sub">Meses indexados ‚Äî 100 = promedio</div>
      <div class="chart-container" style="height:260px">
        <canvas id="chartEstacionalidad"></canvas>
      </div>
    </div>
  </div>

  <div class="chart-card" style="margin-bottom:16px">
    <div class="chart-title">BC1 vs BC2 ‚Äî Ventas Mensuales Comparativo</div>
    <div class="chart-sub">Ambos locales en el mismo eje</div>
    <div class="chart-container" style="height:240px">
      <canvas id="chartBC1vsBC2"></canvas>
    </div>
  </div>

  <div class="insight">
    <div class="insight-title">üí° Insights Ventas</div>
    <div class="insight-text">
      ‚Ä¢ <strong>Temporada alta BC1:</strong> Julio ($146M), Octubre ($152M), Agosto ($148M) ‚Äî Sem 2 claramente superior.<br>
      ‚Ä¢ <strong>Temporada baja BC1:</strong> Febrero ($109M) y Septiembre ($124M) ‚Äî ca√≠das que requieren activaci√≥n.<br>
      ‚Ä¢ <strong>BC2 crecimiento:</strong> De $36M (Feb) a pico de $53.7M (Jul) = +49% en 5 meses. Luego se estabiliza entre $43-51M.<br>
      ‚Ä¢ <strong>Ratio BC2/BC1:</strong> BC2 representa en promedio el <strong>31%</strong> de las ventas de BC1. Margen de crecimiento importante.
    </div>
  </div>
</div>

<!-- ===================== COSTOS ===================== -->
<div class="section" id="section-costos">
  <div class="section-divider">Food Cost & Margen de Contribuci√≥n</div>

  <div class="charts-grid-3">
    <div class="chart-card">
      <div class="chart-title">COGS BC1</div>
      <div class="chart-sub">% sobre ventas ¬∑ target &lt;30%</div>
      <div class="chart-container" style="height:200px">
        <canvas id="chartCOGSBC1"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">COGS BC2</div>
      <div class="chart-sub">% sobre ventas ¬∑ target &lt;30%</div>
      <div class="chart-container" style="height:200px">
        <canvas id="chartCOGSBC2"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Ganancia BC1+BC2</div>
      <div class="chart-sub">Suma mensual pesos</div>
      <div class="chart-container" style="height:200px">
        <canvas id="chartGananciaCombinada"></canvas>
      </div>
    </div>
  </div>

  <div class="table-wrap">
    <div class="table-header">
      <div class="chart-title" style="margin:0">Desglose Mensual ‚Äî Costos & Margen</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Mes</th>
          <th>Ventas BC1</th>
          <th>COGS BC1</th>
          <th>Ganancia BC1</th>
          <th>Ventas BC2</th>
          <th>COGS BC2</th>
          <th>Ganancia BC2</th>
          <th>Ganancia Total</th>
        </tr>
      </thead>
      <tbody id="tablaCostos"></tbody>
    </table>
  </div>
</div>

<!-- ===================== PERSONAL ===================== -->
<div class="section" id="section-personal">
  <div class="section-divider">Costo de Personal ‚Äî An√°lisis Cr√≠tico</div>

  <div class="kpi-strip" style="grid-template-columns:repeat(4,1fr)">
    <div class="kpi">
      <div class="kpi-label">Prom Personal BC1 2025</div>
      <div class="kpi-value red">25.2%</div>
      <div class="kpi-sub">Target: &lt;20%</div>
      <div class="kpi-delta down">+5.2pp</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Prom Personal BC2 2025</div>
      <div class="kpi-value red">31.5%</div>
      <div class="kpi-sub">Target: &lt;20%</div>
      <div class="kpi-delta down">+11.5pp</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Peor mes BC1</div>
      <div class="kpi-value red">29.6%</div>
      <div class="kpi-sub">Ene 2026</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Peor mes BC2</div>
      <div class="kpi-value red">44%</div>
      <div class="kpi-sub">Diciembre 2025 üö®</div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Costo Personal BC1 vs BC2</div>
      <div class="chart-sub">% sobre ventas ‚Äî l√≠nea target 20%</div>
      <div class="chart-container" style="height:260px">
        <canvas id="chartPersonalDetalle"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Correlaci√≥n Personal vs Ganancia BC1</div>
      <div class="chart-sub">Cuando personal sube, ganancia cae</div>
      <div class="chart-container" style="height:260px">
        <canvas id="chartCorrelacion"></canvas>
      </div>
    </div>
  </div>

  <div class="alert-card red" style="margin-bottom:16px">
    <div class="alert-title">üö® An√°lisis Costo Personal ‚Äî Acci√≥n Requerida</div>
    <div class="alert-body" style="font-size:13px; line-height:1.8">
      El costo de personal <strong>nunca ha cumplido el target de &lt;20%</strong> en ning√∫n mes de los √∫ltimos 13.<br>
      BC1 promedia <strong>25.2%</strong> ‚Äî requiere reducir aprox. <strong>$7M/mes</strong> para llegar al target.<br>
      BC2 es m√°s cr√≠tico a√∫n: <strong>31.5% promedio</strong> con picos extremos en Dic ($44%) y Jun (34.7%).<br>
      Opciones: revisi√≥n de dotaci√≥n, optimizaci√≥n de turnos, reducci√≥n de horas extras, o incremento de ventas para diluir el costo fijo.
    </div>
  </div>
</div>

<!-- ===================== TABLA ===================== -->
<div class="section" id="section-tabla">
  <div class="section-divider">Datos Hist√≥ricos Completos</div>
  <div class="table-wrap">
    <div class="table-header">
      <div class="chart-title" style="margin:0">Todos los KPIs ‚Äî Feb 2025 a Ene 2026</div>
      <span class="badge">13 meses</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>Mes</th>
          <th>Ventas BC1</th>
          <th>COGS BC1</th>
          <th>Personal BC1</th>
          <th>Ganancia BC1</th>
          <th>Ventas BC2</th>
          <th>COGS BC2</th>
          <th>Personal BC2</th>
          <th>Ganancia BC2</th>
          <th>Total Ventas</th>
          <th>Total Ganancia</th>
        </tr>
      </thead>
      <tbody id="tablaCompleta"></tbody>
    </table>
  </div>
</div>

</div><!-- /main -->

<script>
// ===================== DATA =====================
const meses = ['Ene 25','Feb 25','Mar 25','Abr 25','May 25','Jun 25','Jul 25','Ago 25','Sep 25','Oct 25','Nov 25','Dic 25','Ene 26'];
const mesLabels = ['Enero 2025','Febrero 2025','Marzo 2025','Abril 2025','Mayo 2025','Junio 2025','Julio 2025','Agosto 2025','Septiembre 2025','Octubre 2025','Noviembre 2025','Diciembre 2025','Enero 2026'];

const bc1Ventas = [133793247,109757194,139331581,134170878,138128030,136524283,146121376,148558896,124490201,152705770,148768753,136289900,135849824];
const bc2Ventas = [0,36018438,42655815,46422486,42856430,44472802,53720754,45546157,43166000,51360592,48133836,43506993,47063795];
const bc1COGS =   [null,34.77,28.97,29.14,29.49,30.34,31.15,32.12,31.96,29.50,30.35,32.89,31.06];
const bc2COGS =   [null,34.45,28.82,34.35,27.80,28.35,26.84,30.33,28.98,28.71,30.44,27.99,27.70];
const bc1Ganancia=[28860054,9646214,29915850,21745708,23938248,17651136,22560828,14557051,5412047,26011407,331586,3777120,12892368];
const bc2Ganancia=[0,1941008,3050963,6430838,4271323,3573603,11832861,4673220,3538169,10230542,3774539,3702056,4019246];
const bc1Personal=[null,25.46,22.39,23.84,23.63,24.32,24.32,26.25,29.02,25.43,26.15,27.70,29.60];
const bc2Personal=[null,21.89,30.89,28.39,33.62,34.69,28.02,32.28,33.57,29.92,34.24,44.00,32.34];

// Colors
const GOLD = '#C9A84C';
const GOLD_T = 'rgba(201,168,76,0.15)';
const BLUE = '#42A5F5';
const BLUE_T = 'rgba(66,165,245,0.15)';
const RED = '#E53935';
const GREEN = '#4CAF50';

// Chart defaults
Chart.defaults.color = '#888';
Chart.defaults.borderColor = '#2A2A2A';
Chart.defaults.font.family = 'DM Mono';
Chart.defaults.font.size = 11;

function fmt(n) {
  if(!n && n!==0) return '-';
  if(Math.abs(n) >= 1e9) return '$' + (n/1e9).toFixed(2) + 'B';
  if(Math.abs(n) >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
  return '$' + n.toLocaleString('es-CL');
}

// ===================== BUILD TABLES =====================
function buildTablaCostos() {
  const tbody = document.getElementById('tablaCostos');
  mesLabels.forEach((mes,i) => {
    const ganTotal = bc1Ganancia[i] + bc2Ganancia[i];
    const cogsBC1Class = bc1COGS[i] ? (bc1COGS[i] < 30 ? 'td-good' : bc1COGS[i] < 32 ? 'td-warn' : 'td-bad') : '';
    const cogsBC2Class = bc2COGS[i] ? (bc2COGS[i] < 30 ? 'td-good' : bc2COGS[i] < 32 ? 'td-warn' : 'td-bad') : '';
    const ganBC1Class = bc1Ganancia[i] > 20e6 ? 'td-good' : bc1Ganancia[i] > 5e6 ? 'td-warn' : 'td-bad';
    const ganTotalClass = ganTotal > 20e6 ? 'td-good' : ganTotal > 5e6 ? 'td-warn' : 'td-bad';
    tbody.innerHTML += `<tr>
      <td>${mes}</td>
      <td>${fmt(bc1Ventas[i])}</td>
      <td class="${cogsBC1Class}">${bc1COGS[i] ? bc1COGS[i].toFixed(2)+'%' : '-'}</td>
      <td class="${ganBC1Class}">${fmt(bc1Ganancia[i])}</td>
      <td>${bc2Ventas[i] ? fmt(bc2Ventas[i]) : '<span class="td-muted">BC2 no operaba</span>'}</td>
      <td class="${cogsBC2Class}">${bc2COGS[i] ? bc2COGS[i].toFixed(2)+'%' : '-'}</td>
      <td class="${bc2Ganancia[i] > 3e6 ? 'td-good' : 'td-warn'}">${bc2Ganancia[i] ? fmt(bc2Ganancia[i]) : '-'}</td>
      <td class="${ganTotalClass}">${fmt(ganTotal)}</td>
    </tr>`;
  });
}

function buildTablaCompleta() {
  const tbody = document.getElementById('tablaCompleta');
  mesLabels.forEach((mes,i) => {
    const totalV = bc1Ventas[i] + bc2Ventas[i];
    const totalG = bc1Ganancia[i] + bc2Ganancia[i];
    const pc1 = bc1Personal[i];
    const pc2 = bc2Personal[i];
    const pc1Class = pc1 ? (pc1 < 22 ? 'td-good' : pc1 < 27 ? 'td-warn' : 'td-bad') : '';
    const pc2Class = pc2 ? (pc2 < 25 ? 'td-good' : pc2 < 33 ? 'td-warn' : 'td-bad') : '';
    tbody.innerHTML += `<tr>
      <td>${mes}</td>
      <td>${fmt(bc1Ventas[i])}</td>
      <td class="${bc1COGS[i]?( bc1COGS[i]<30?'td-good':bc1COGS[i]<32?'td-warn':'td-bad'):''}">${bc1COGS[i]?bc1COGS[i].toFixed(2)+'%':'-'}</td>
      <td class="${pc1Class}">${pc1?pc1.toFixed(2)+'%':'-'}</td>
      <td class="${bc1Ganancia[i]>15e6?'td-good':bc1Ganancia[i]>3e6?'td-warn':'td-bad'}">${fmt(bc1Ganancia[i])}</td>
      <td>${bc2Ventas[i]?fmt(bc2Ventas[i]):'<span class="td-muted">‚Äî</span>'}</td>
      <td class="${bc2COGS[i]?( bc2COGS[i]<30?'td-good':bc2COGS[i]<32?'td-warn':'td-bad'):''}">${bc2COGS[i]?bc2COGS[i].toFixed(2)+'%':'-'}</td>
      <td class="${pc2Class}">${pc2?pc2.toFixed(2)+'%':'-'}</td>
      <td class="${bc2Ganancia[i]>4e6?'td-good':bc2Ganancia[i]>1e6?'td-warn':'td-bad'}">${bc2Ganancia[i]?fmt(bc2Ganancia[i]):'-'}</td>
      <td>${fmt(totalV)}</td>
      <td class="${totalG>25e6?'td-good':totalG>5e6?'td-warn':'td-bad'}">${fmt(totalG)}</td>
    </tr>`;
  });
}

// ===================== CHARTS =====================
const opts = {
  responsive: true, maintainAspectRatio: false,
  plugins: { legend: { display: true, labels: { boxWidth: 10, padding: 16 } }, tooltip: { callbacks: { label: ctx => ' ' + (typeof ctx.raw === 'number' && ctx.raw > 1e5 ? fmt(ctx.raw) : (ctx.raw?.toFixed?.(2) ?? ctx.raw) + (ctx.dataset.isPercent?'%':'')) } } },
  scales: {
    x: { grid: { color: '#1E1E1E' }, ticks: { maxRotation: 0 } },
    y: { grid: { color: '#1E1E1E' } }
  }
};

function makeOpts(extra={}) { return Object.assign(JSON.parse(JSON.stringify(opts)), extra); }

// 1. Ventas combinadas
new Chart('chartVentasCombinadas', {
  type: 'bar',
  data: {
    labels: meses,
    datasets: [
      { label: 'BC1', data: bc1Ventas, backgroundColor: GOLD, borderRadius: 3, stack: 'v' },
      { label: 'BC2', data: bc2Ventas, backgroundColor: BLUE, borderRadius: 3, stack: 'v' }
    ]
  },
  options: { ...makeOpts(), scales: { x: { grid:{color:'#1E1E1E'}, stacked: true }, y: { grid:{color:'#1E1E1E'}, stacked: true, ticks: { callback: v => '$' + (v/1e6).toFixed(0)+'M' } } } }
});

// 2. Ganancia
new Chart('chartGanancia', {
  type: 'bar',
  data: {
    labels: meses,
    datasets: [
      { label: 'BC1', data: bc1Ganancia, backgroundColor: GOLD, borderRadius: 3 },
      { label: 'BC2', data: bc2Ganancia, backgroundColor: BLUE, borderRadius: 3 }
    ]
  },
  options: { ...makeOpts(), scales: { x:{grid:{color:'#1E1E1E'}}, y:{grid:{color:'#1E1E1E'}, ticks:{callback: v => '$'+(v/1e6).toFixed(0)+'M'}} } }
});

// 3. COGS
new Chart('chartCOGS', {
  type: 'line',
  data: {
    labels: meses,
    datasets: [
      { label: 'COGS BC1', data: bc1COGS, borderColor: GOLD, backgroundColor: GOLD_T, tension: 0.3, fill: false, pointRadius: 4 },
      { label: 'COGS BC2', data: bc2COGS, borderColor: BLUE, backgroundColor: BLUE_T, tension: 0.3, fill: false, pointRadius: 4 },
      { label: 'Target 30%', data: Array(13).fill(30), borderColor: RED, borderDash: [5,5], pointRadius: 0, fill: false }
    ]
  },
  options: { ...makeOpts(), scales: { x:{grid:{color:'#1E1E1E'}}, y:{grid:{color:'#1E1E1E'}, min:24, max:38, ticks:{callback: v=>v+'%'}} } }
});

// 4. Personal
new Chart('chartPersonal', {
  type: 'line',
  data: {
    labels: meses,
    datasets: [
      { label: 'Personal BC1', data: bc1Personal, borderColor: GOLD, tension: 0.3, fill: false, pointRadius: 4 },
      { label: 'Personal BC2', data: bc2Personal, borderColor: BLUE, tension: 0.3, fill: false, pointRadius: 4 },
      { label: 'Target 20%', data: Array(13).fill(20), borderColor: RED, borderDash: [5,5], pointRadius: 0, fill: false }
    ]
  },
  options: { ...makeOpts(), scales: { x:{grid:{color:'#1E1E1E'}}, y:{grid:{color:'#1E1E1E'}, min:15, max:48, ticks:{callback: v=>v+'%'}} } }
});

// 5. BC1 Ventas
new Chart('chartBC1ventas', {
  type: 'line',
  data: {
    labels: meses,
    datasets: [{ label: 'Ventas BC1', data: bc1Ventas, borderColor: GOLD, backgroundColor: GOLD_T, tension: 0.3, fill: true, pointRadius: 5 }]
  },
  options: { ...makeOpts(), plugins:{legend:{display:false}}, scales: { x:{grid:{color:'#1E1E1E'}}, y:{grid:{color:'#1E1E1E'}, ticks:{callback: v=>'$'+(v/1e6).toFixed(0)+'M'}} } }
});

// 6. Estacionalidad
const avg1 = bc1Ventas.filter((_,i)=>i<12).reduce((a,b)=>a+b,0)/12;
const idx = bc1Ventas.map((v,i)=> i<12 ? Math.round(v/avg1*100) : null);
new Chart('chartEstacionalidad', {
  type: 'bar',
  data: {
    labels: meses.slice(0,12),
    datasets: [{ label: '√çndice (100=prom)', data: idx.slice(0,12), backgroundColor: idx.slice(0,12).map(v => v>=100 ? 'rgba(76,175,80,0.7)' : 'rgba(229,57,53,0.6)'), borderRadius: 3 }]
  },
  options: { ...makeOpts(), plugins:{legend:{display:false}}, scales: { x:{grid:{color:'#1E1E1E'}}, y:{grid:{color:'#1E1E1E'}, ticks:{callback: v=>v}} } }
});

// 7. BC1 vs BC2
new Chart('chartBC1vsBC2', {
  type: 'bar',
  data: {
    labels: meses,
    datasets: [
      { label: 'BC1', data: bc1Ventas, backgroundColor: GOLD, borderRadius: 3 },
      { label: 'BC2', data: bc2Ventas, backgroundColor: BLUE, borderRadius: 3 }
    ]
  },
  options: { ...makeOpts(), scales: { x:{grid:{color:'#1E1E1E'}}, y:{grid:{color:'#1E1E1E'}, ticks:{callback: v=>'$'+(v/1e6).toFixed(0)+'M'}} } }
});

// 8. COGS BC1
new Chart('chartCOGSBC1', {
  type: 'bar',
  data: {
    labels: meses,
    datasets: [{ label: 'COGS BC1', data: bc1COGS, backgroundColor: bc1COGS.map(v => !v?'#333':v<30?'rgba(76,175,80,0.7)':v<32?'rgba(255,193,7,0.7)':'rgba(229,57,53,0.7)'), borderRadius: 3 }]
  },
  options: { ...makeOpts(), plugins:{legend:{display:false}}, scales: { x:{grid:{color:'#1E1E1E'}}, y:{grid:{color:'#1E1E1E'}, min:24, max:38, ticks:{callback: v=>v+'%'}} } }
});

// 9. COGS BC2
new Chart('chartCOGSBC2', {
  type: 'bar',
  data: {
    labels: meses,
    datasets: [{ label: 'COGS BC2', data: bc2COGS, backgroundColor: bc2COGS.map(v => !v?'#333':v<30?'rgba(76,175,80,0.7)':v<32?'rgba(255,193,7,0.7)':'rgba(229,57,53,0.7)'), borderRadius: 3 }]
  },
  options: { ...makeOpts(), plugins:{legend:{display:false}}, scales: { x:{grid:{color:'#1E1E1E'}}, y:{grid:{color:'#1E1E1E'}, min:24, max:38, ticks:{callback: v=>v+'%'}} } }
});

// 10. Ganancia combinada
const ganTotal = bc1Ganancia.map((v,i)=>v+bc2Ganancia[i]);
new Chart('chartGananciaCombinada', {
  type: 'bar',
  data: {
    labels: meses,
    datasets: [{ label: 'Ganancia Total', data: ganTotal, backgroundColor: ganTotal.map(v=>v>20e6?'rgba(76,175,80,0.7)':v>5e6?'rgba(255,193,7,0.7)':'rgba(229,57,53,0.7)'), borderRadius: 3 }]
  },
  options: { ...makeOpts(), plugins:{legend:{display:false}}, scales: { x:{grid:{color:'#1E1E1E'}}, y:{grid:{color:'#1E1E1E'}, ticks:{callback: v=>'$'+(v/1e6).toFixed(0)+'M'}} } }
});

// 11. Personal detalle
new Chart('chartPersonalDetalle', {
  type: 'line',
  data: {
    labels: meses,
    datasets: [
      { label: 'Personal BC1 %', data: bc1Personal, borderColor: GOLD, backgroundColor: GOLD_T, tension: 0.3, fill: true, pointRadius: 5 },
      { label: 'Personal BC2 %', data: bc2Personal, borderColor: BLUE, backgroundColor: BLUE_T, tension: 0.3, fill: true, pointRadius: 5 },
      { label: 'Target 20%', data: Array(13).fill(20), borderColor: RED, borderDash: [5,5], pointRadius: 0, fill: false }
    ]
  },
  options: { ...makeOpts(), scales: { x:{grid:{color:'#1E1E1E'}}, y:{grid:{color:'#1E1E1E'}, min:15, max:48, ticks:{callback: v=>v+'%'}} } }
});

// 12. Correlaci√≥n Personal vs Ganancia BC1
new Chart('chartCorrelacion', {
  type: 'line',
  data: {
    labels: meses,
    datasets: [
      { label: 'Ganancia BC1 ($M)', data: bc1Ganancia.map(v=>Math.round(v/1e6*10)/10), borderColor: GREEN, tension: 0.3, fill: false, pointRadius: 4, yAxisID: 'y' },
      { label: 'Personal BC1 %', data: bc1Personal, borderColor: RED, tension: 0.3, fill: false, pointRadius: 4, yAxisID: 'y2' }
    ]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: true, labels: { boxWidth: 10, padding: 16 } } },
    scales: {
      x: { grid:{color:'#1E1E1E'} },
      y: { grid:{color:'#1E1E1E'}, position:'left', ticks:{callback: v=>'$'+v+'M'} },
      y2: { grid:{display:false}, position:'right', ticks:{callback: v=>v+'%'} }
    }
  }
});

// ===================== TABS =====================
function showSection(id) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('section-'+id).classList.add('active');
  event.target.classList.add('active');
}

// Build tables
buildTablaCostos();
buildTablaCompleta();
</script>
</body>
</html>
